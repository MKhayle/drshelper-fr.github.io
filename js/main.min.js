"use strict";var VIVI,ARENA,SPEED,timerHOTCOLD,timerBRAND,timerMECHANIC;const ARENA_LENGTH=4,FORMS=["formUseTimer","formMarkSafe","formGetBrand","formSkipDebuffs"],SAFE_SPOTS=[1,2,3,4],SWORDS=["swordn","sworde","swordw","swords"],TEMPERATURES=[-2,-1,1,2],THERMOMETERS=["meter-2","meter-1","meter1","meter2"],TILES=["tile00","tile10","tile20","tile30","tile01","tile11","tile21","tile31","tile02","tile12","tile22","tile32","tile03","tile13","tile23","tile33"];class Vivi{constructor(e,t){this.hotcold=e,this.brand=t,this.bodyTemp=e,this.position="tile12"}set position(e){this.tile=e,this.x=parseInt(e.slice(4,5)),this.y=parseInt(e.slice(5))}win(){hide("vivi-south"),show("vivi-win"),updateStatus("F\xe9licitations! Vous avez su r\xe9soudre parfaitement la m\xe9canique et avez surv\xe9cu!")}dead(e="Votre temp\xe9rature est rest\xe9e instable et vous \xeates tomb\xe9\xb7e KOâ€™d&nbsp;:("){hide("vivi-south"),show("vivi-dead"),removeOptions(),clearInterval(timerHOTCOLD),write("txt-hotcold"),clearInterval(timerBRAND),write("txt-brand"),clearInterval(timerMECHANIC),updateStatus(e)}sword(e){let t=this.x,s=this.y;ARENA[`hits${e}`][s][t]>1?(this.dead("Vous avez \xe9t\xe9 touch\xe9\xb7e par deux \xe9p\xe9es \xe0 la fois!"),this.bodyTemp=100):this.check(ARENA[`temps${e}`][s][t])}check(e){let t=this.bodyTemp+e;t>2||t<-2?(this.bodyTemp=t,t>2?this.dead("Votre temp\xe9rature corporelle est devenue bien trop \xe9lev\xe9e et vous avez br\xfbl\xe9 vif !"):this.dead("Votre temp\xe9rature corporelle est devenue bien trop faible et vous avez fini surgel\xe9 !")):(this.showLife(t),this.bodyTemp=t,writeTempChange(e))}showLife(e){show("ta-life"),hide(`dbf-hc${this.bodyTemp}`),hide(`life${this.bodyTemp}`),show(`dbf-hc${e}`),show(`life${e}`)}}class Arena{constructor(e,t,s,r){this.safe1=e,this.safe2=t,this.meters1=s,this.meters2=r,this.orients1=this.setOrients(e),this.orients2=this.setOrients(t),this.swords1=this.setSwords(e),this.swords2=this.setSwords(t),this.hits1=this.setHits(e),this.hits2=this.setHits(t),this.temps1=this.setHits(e,s),this.temps2=this.setHits(t,r)}colorTiles(e,t=!1){let s=this[`hits${e}`],r,o;for(let i=0;i<4;i++)for(let a=0;a<4;a++){if(t)o="ivory";else{if(0===(r=s[a][i]))continue;o=2===r?"sandybrown":"peachpuff"}d3.select(`#bg${i}${a}`).style("fill",o)}if(!t)return setTimeout(this.colorTiles,SPEED,e,!0)}showClones(){this.clones(showAll)}hideClones(){this.clones(hideAll)}clones(e){e(["bossn","bossw","bosss"])}rotateBosses(e){let t,s=this[`orients${e}`],r=["n","e","w","s"];for(let o=0;o<r.length;o++){switch(s[o]){case"n":t=180;break;case"e":t=270;break;case"w":t=90;break;default:t=0}d3.select(`#face${r[o]}`).attr("transform",`translate(17, 17) rotate(${t}) translate(-17, -17)`)}}meters(e){let t=this[`meters${e}`];move(`meter${t[0]}`,73,26),move(`meter${t[1]}`,113,66),move(`meter${t[2]}`,33,66),move(`meter${t[3]}`,73,106),showAll(THERMOMETERS)}swords(e){let t=this[`swords${e}`],s=this[`meters${e}`],r,o;switch(t.indexOf("swordn")){case 0:[r,o]=[87,10.5];break;case 1:[r,o]=[127,50.5];break;default:[r,o]=[39,50.5]}switch(move("swordn",r,o),t.indexOf("sworde")){case 0:[r,o]=[95.5,39];break;case 1:[r,o]=[135.5,79];break;default:[r,o]=[95.5,127]}switch(move("sworde",r,o),t.indexOf("swordw")){case 0:[r,o]=[50.5,39];break;case 2:[r,o]=[10.5,79];break;default:[r,o]=[50.5,127]}switch(move("swordw",r,o),t.indexOf("swords")){case 1:[r,o]=[127,95.5];break;case 2:[r,o]=[39,95.5];break;default:[r,o]=[87,135.5]}move("swords",r,o);for(let i=0;i<SWORDS.length;i++)d3.select(`#${t[i]}`).styles({fill:s[i]>0?"#f08080":"#87cefa",stroke:s[i]>0?"#531515":"#4668a6"}),show(SWORDS[i])}showSwords(e){this.meters(e),this.swords(e),sessionStorage.getItem("formMarkSafe")&&show(`tilesafe${this[`safe${e}`]}`)}hideSwords(){hideAll(THERMOMETERS),hideAll(SWORDS),hideAll([`tilesafe${this.safe1}`,`tilesafe${this.safe2}`])}setOrients(e){let t=(t,s)=>e===t||e===s?getRandItem(["n","s"]):getRandItem(["e","w"]),s=t(3,4),r=t(2,3),o=t(1,4),i=t(1,2);return[s,r,o,i]}setSwords(e){let t=[];switch(e){case 1:t=["swordn","swords","swordw","sworde"];break;case 2:t=["swordn","sworde","swords","swordw"];break;case 3:t=["swordw","sworde","swordn","swords"];break;default:t=["sworde","swordn","swordw","swords"]}return t}setHits(e,t=[1,1,1,1]){let s=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],r=[];switch(e){case 1:r=["sm-n","bg-s","sm-w","bg-e"];break;case 2:r=["sm-n","sm-e","bg-s","bg-w"];break;case 3:r=["bg-w","sm-e","bg-n","sm-s"];break;default:r=["bg-e","bg-n","sm-w","sm-s"]}for(let o=0;o<s.length;o++)for(let i=0;i<s[o].length;i++)for(let a=0;a<r.length;a++)switch(r[a]){case"bg-n":o<2&&(s[o][i]+=t[a]);break;case"bg-e":i>1&&(s[o][i]+=t[a]);break;case"bg-w":i<2&&(s[o][i]+=t[a]);break;case"bg-s":o>1&&(s[o][i]+=t[a]);break;case"sm-n":o<1&&(s[o][i]+=t[a]);break;case"sm-e":i>2&&(s[o][i]+=t[a]);break;case"sm-w":i<1&&(s[o][i]+=t[a]);break;case"sm-s":o>2&&(s[o][i]+=t[a]);break;default:s[o][i]=8}return s}}function saveSettings(){let e=e=>d3.select(`#${e}`).property("checked"),t=e=>sessionStorage.setItem(e,"true");for(let s of(sessionStorage.clear(),FORMS))e(s)&&t(s);startPractice()}function setPractice(){let e,t=0,s,r,o,i,a;if(e=getRandItem(TEMPERATURES),sessionStorage.getItem("formGetBrand"))for(t=getRandItem(TEMPERATURES);e+t===0;)t=getRandItem(TEMPERATURES);for(s=getRandItem(SAFE_SPOTS),r=getRandItem(SAFE_SPOTS);s===r;)r=getRandItem(SAFE_SPOTS);o=shuffle(TEMPERATURES);do{a=!1,i=shuffle(TEMPERATURES);for(let n=0;n<TEMPERATURES.length;n++)if(o[n]===i[n]){a=!0;break}}while(a);VIVI=new Vivi(e,t),ARENA=new Arena(s,r,o,i)}function startPractice(){hide("btnStartPractice"),showAll(["btnPractiseAgain","btnEditSettings"]),setPractice(),hide("settings"),show("info"),addOptions(),show("bosse"),sessionStorage.getItem("formUseTimer")?(SPEED=1e3,sessionStorage.getItem("formSkipDebuffs")?(sessionStorage.getItem("formGetBrand")&&startTimerBrand(),startTimerHotCold(),showAll(["dbf-intemp",`dbf-eb${VIVI.brand}`]),VIVI.showLife(VIVI.bodyTemp)):startMechanic("Chaud et froid")):(SPEED=1e3,showAll(["btnResolveSwords1","dbf-intemp",`dbf-eb${VIVI.brand}`]),VIVI.showLife(VIVI.bodyTemp),writeTempChange(VIVI.hotcold),ARENA.showClones(),ARENA.rotateBosses(1),ARENA.showSwords(1))}function resolveSwords1(){updateStatus(),ARENA.colorTiles(1),setTimeout(function(){hide("btnResolveSwords1"),VIVI.sword(1),100!==VIVI.bodyTemp&&VIVI.bodyTemp>=-2&&VIVI.bodyTemp<=2&&(ARENA.hideSwords(),ARENA.rotateBosses(2),ARENA.showSwords(2),show("btnResolveSwords2"))},SPEED)}function resolveSwords2(){updateStatus(),ARENA.colorTiles(2),setTimeout(function(){hide("btnResolveSwords2"),VIVI.sword(2),100!==VIVI.bodyTemp&&VIVI.bodyTemp>=-2&&VIVI.bodyTemp<=2&&(removeOptions(),ARENA.hideSwords(),sessionStorage.getItem("formGetBrand")?show("btnResolveBrand"):resolveBrand())},SPEED)}function resolveBrand(){hide("btnResolveBrand"),ARENA.hideClones(),VIVI.check(VIVI.brand),hide(`dbf-eb${VIVI.brand}`),0===VIVI.bodyTemp?VIVI.win():VIVI.dead()}function startTimerHotCold(){let e=0===VIVI.brand?42:49;sessionStorage.getItem("formSkipDebuffs")&&(e=39);let t=(e="&nbsp;")=>write("txt-hotcold",e);t(e),timerHOTCOLD=setInterval(function(){switch(t(--e),e){case 0:clearInterval(timerHOTCOLD),t(),0===VIVI.bodyTemp?VIVI.win():VIVI.dead();break;case 4:ARENA.hideClones();break;case 7:removeOptions(),VIVI.sword(2);break;case 8:ARENA.colorTiles(2);break;case 17:startMechanic("Sabre du feu et de la glace",10),ARENA.showSwords(2);break;case 18:ARENA.rotateBosses(2);break;case 20:VIVI.sword(1);break;case 21:ARENA.colorTiles(1);break;case 30:startMechanic("Sabre du feu et de la glace",10),ARENA.showSwords(1);break;case 31:ARENA.rotateBosses(1);break;case 38:startMechanic("Spectres du chevalier implacable");break;case 46:startMechanic("Mal\xe9diction du feu et de la glace")}},SPEED)}function startTimerBrand(){let e=38;sessionStorage.getItem("formSkipDebuffs")&&(e=35);let t=VIVI.brand,s=(e="&nbsp;")=>write("txt-brand",e);s(e),show(`dbf-eb${t}`),timerBRAND=setInterval(function(){s(--e),e<=0&&(clearInterval(timerBRAND),s(),VIVI.check(t),(VIVI.bodyTemp>=-2||VIVI.bodyTemp<=2)&&hide(`dbf-eb${t}`))},SPEED)}function startMechanic(e,t=4){let s=`Va incanter <b>${e}</b> dans... `;updateStatus(s+t),timerMECHANIC=setInterval(function(){if(--t<=0){switch(e){case"Sabre du feu et de la glace":ARENA.hideSwords();break;case"Spectres du chevalier implacable":ARENA.showClones(),updateStatus();break;case"Mal\xe9diction du feu et de la glace":startTimerBrand(),updateStatus();break;case"Chaud et froid":startTimerHotCold(),show("dbf-intemp"),VIVI.showLife(VIVI.bodyTemp),writeTempChange(VIVI.hotcold)}clearInterval(timerMECHANIC)}else updateStatus(s+t)},SPEED)}function clickTile(){VIVI.position=this.id,move("vivi-ans",40*VIVI.x+18,40*VIVI.y+16)}function addOptions(){options(clickTile)}function removeOptions(){options(null)}function options(e){for(let t of TILES)d3.select(`#${t}`).on("click",e)}function practiseAgain(){sessionStorage.setItem("practiseAgain","true"),location.reload()}function editSettings(){sessionStorage.setItem("editSettings","true"),location.reload()}function getRandItem(e){return e[Math.floor(Math.random()*e.length)]}function shuffle(e){let t=e.slice();for(let s=t.length-1;s>0;s--){let r=Math.floor(Math.random()*(s+1));[t[s],t[r]]=[t[r],t[s]]}return t}function move(e,t,s){d3.select(`#${e}`).attr("transform",`translate(${t}, ${s})`)}function hide(e){d3.select(`#${e}`).classed("hidden",!0)}function show(e){d3.select(`#${e}`).classed("hidden",!1)}function hideAll(e){for(let t of e)hide(t)}function showAll(e){for(let t of e)show(t)}function updateStatus(e="&nbsp;"){write("status",e)}function write(e,t="&nbsp;"){d3.select(`#${e}`).html(t)}function writeTempChange(e){let t,s,r;0!==e&&(t=`<i>Votre temp\xe9rature corporelle ${s=e<0?"a chut\xe9 de":"a augment\xe9 de"} ${e} niveau${r=(e=Math.abs(e))>1?"x":""}.</i>`),updateStatus(t)}function recheckForm(e){let t=!!sessionStorage.getItem(e);d3.select(`#${e}`).property("checked",t)}function addFuncToBtn(e,t){return d3.select(`#btn${t}`).on("click",e)}addFuncToBtn(saveSettings,"StartPractice"),addFuncToBtn(resolveSwords1,"ResolveSwords1"),addFuncToBtn(resolveSwords2,"ResolveSwords2"),addFuncToBtn(resolveBrand,"ResolveBrand"),addFuncToBtn(practiseAgain,"PractiseAgain"),addFuncToBtn(editSettings,"EditSettings"),window.onload=function(){sessionStorage.getItem("practiseAgain")?(sessionStorage.removeItem("practiseAgain"),startPractice()):(sessionStorage.getItem("editSettings")&&(sessionStorage.removeItem("editSettings"),recheckForm("formUseTimer"),recheckForm("formMarkSafe"),recheckForm("formGetBrand"),recheckForm("formSkipDebuffs")),show("settings"))};